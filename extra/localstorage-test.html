<!doctype html>
<html>
  <head>
    <title>Localstorage Test</title>
  </head>
  <body>
    <div id = 'results'></div>
    
    <script>
      // pauses execution for a short period of time
      function pauseExecution() {
        return new Promise(r => setTimeout(r, 15));
      }
      
      // finds the maximum input of a function that returns true, using exponentially increasing binary search
      async function findMaxInput(inputFunc) {
        let lowerBound = 0, upperBound = 2;
        
        // doubling phase
        while (inputFunc(upperBound)) {
          lowerBound = upperBound;
          upperBound *= 2;
          results.innerText += `Rising: ${lowerBound} ${upperBound}\n`;
          await pauseExecution();
        }
        
        // now function returned false for first time, now find where it was false
        while (upperBound - lowerBound > 0) {
          let trueHalfway = (lowerBound + upperBound) / 2;
          let lowerHalfway = Math.floor(trueHalfway);
          let upperHalfway = Math.ceil(trueHalfway);
          
          if (inputFunc(lowerHalfway)) {
            lowerBound = upperHalfway;
          } else {
            upperBound = lowerHalfway;
          }
          results.innerText += `Narrowing: ${lowerBound} ${upperBound}\n`;
          await pauseExecution();
        }
        
        return lowerBound - 1;
      }
      
      // tests whether the localstorage can handle a string as long as the input
      function localStorageCanHandle(char, length) {
        try {
          localStorage.e = char.repeat(length);
          delete localStorage.e;
          return true;
        } catch (e) {
          return false;
        }
      }
      
      // returns how many times char can be repeated and still fit in localstorage
      async function findMaxLocalStorageLength(char) {
        return await findMaxInput(localStorageCanHandle.bind(null, char));
      }
      
      // returns whether localstorage successfully stored the string without altering it
      function localStorageStoresExactly(string) {
        localStorage.e = string;
        let success = localStorage.e == string;
        delete localStorage.e;
        return success;
      }
      
      (async () => {
        let result;
        
        result = await findMaxLocalStorageLength('e');
        results.innerText += `\nResult for "e": ${result}\n\n`;
        
        result = await findMaxLocalStorageLength('\u7861'); // U+7861; ç¡¡
        results.innerText += `\nResult for "\u7861" ("\\u7861"): ${result}\n\n`;
        
        result = await findMaxLocalStorageLength('\ud83d\ude78'); // U+1F678; ðŸ™¸
        results.innerText += `\nResult for "\ud83d\ude78" ("\ud83d\ude78"; U+1F678): ${result}\n\n`;
        
        let everyCharCode = new Array(65536).fill().map((_, i) => String.fromCharCode(i)).join('');
        result = localStorageStoresExactly(everyCharCode);
        results.innerText += `\nResult for storing every char code: ${result ? 'Success' : 'Failure'}\n\n`;
        
        let invalidSurrogatePair = '\udbff\udfff';
        result = localStorageStoresExactly(invalidSurrogatePair);
        results.innerText += `\nResult for storing an invalid surrogate pair ("${invalidSurrogatePair}"; "\udbff\udfff"): ${result ? 'Success' : 'Failure'}\n\n`;
      })();
    </script>
  </body>
</html>
